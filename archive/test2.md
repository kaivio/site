# Test2 / 排版测试
文件查找

## 用法
### 基本用法
```shell
fq -q name has .json -q size le 1k
```
使用`-q`选项添加一个查找条件，选项接受3个参数，分别表示字段、操作符和输入值。条件可以无限叠加。

条件组之间是与逻辑。 ~~但如果有复数的字段与操作符相同的条件，则是或逻辑(未实现)~~

#### 字段
|字段|描述|备注|
|:---|:----|:---|
|`name`|文件名|DirEntry.name|
|`path`|路径|DirEntry.path|
|`size`|文件大小|stat(path).st_size|
|`time`<br>`mtime`|最后修改时间|stat(path).st_mtime|
|`ctime`|最后更改元数据时间|stat(path).st_ctime|
|`atime`|最后访问时间|stat(path).st_atime|
|...|以及其他状态字段|stat(path).st_*|
|`type`|文件类型|`file`,`dir`,`link`,...
|`text`|文件内容|open(path).read()|

#### 操作符
|操作符|参考(i为输入值，x为实际数据|别名|
|:---|:----|
|`in`|x in i|
|`has`|i in x|
|`match`|re.search(i,x)|
|`prefix`|x.startswith(i)|
|`suffix`|x.endswith(i)|
|`is`|x == i |`eq`, `=`|
|`lt`|x < i|`-`|
|`rt`|x > i|`+`|
|`le`|x <= i|`-=`|
|`re`|x >= i|`+=`|

以上操作符可以加入`not-`前缀来取反。

#### 输入值
在实际做条件比较前，输入会被转换到机器可读的数据，部分字段(如时间)有格式要求，不正确的格式会导致非预期行为。

- 文本
  - 原始内容
- 字节大小
  - 会识别单位，最大到T，不分大小写，，如1k、2mb、3gGiB
- 时间
  - 相对时间
    - 被当前时间减掉，最后换算为时间截
    - 格式与字节大小类似，由于单字母单位存在歧义，接受缩写、简写和单词
    - 1s, 2min, 3minute, 4h, 5mon, 6month, 7y, ...
  - 绝对时间： 未实现
- 文件类型
  - file
  - dir
  - link
  - 其余未实现
- 媒体类型(未实现)
- 二进制数据(未实现)
  - 以 `编码:数据体` 格式表示，如：
  - `hex:d3540a`
  - `base64:ZGplYnNqY253ancK`
  - `ascii:hello\xFFworld`

### 简写用法
```
fq .json 1k
```

不用`-q`选项，而直接输入参数会以如下规则转换为完整的条件

#### 量词比较
参数以数字开头时会尝试识别量词，通常是字节大小和时间。量词可以附带一个增减后缀，以表示大于和小于。

```shell
fq 1k      # 小于等于 1kb
fq -q size le 1k
fq 10mib+  # 大于 10mib
fq -q size rt 10mib
fq 5h      # 修改时间大于等于5小时前
fq -q mtime re 5h
fq 4min-   # 修改时间小于4分钟前
fq -q mtime lt 4min
fq 1d+=    m 修改时间大于等于1天前
fq -q mtime re 1d
```

如果缺少增减后缀，时间值做大于等于比较(`+=`)，其他值则做小于等于(`-=`)比较。

时间字段为`mtime`

#### 文件名匹配
**前缀后缀匹配：**\
当以`.`开头或结尾时视为前缀/后缀匹配，如
```shell
fq .py      # 等价于 fq -q name suffix .py 
fq hello.   # 等价于 fq -q name prefix hello.
```

**正则表达式匹配**：\
当以`/`开头和结尾时，视为正则表达式匹配，如：
```shell
fq '/\d+/' # 等价于 fq -q name match '\d+'
```

**子串查找**：\
当以上规则都不满足时，被视为子串查找。

特别的，如果以`/`开头但不以`/`结尾，则会强制提取`/`后面字符做子串查找。以此来回避其他规则。



### 选项

|选项|描述|参数默认值(*为必须, None表示标志)
|:---|:----|:---|
|`--from`|要查找的目录(可叠加)|`.`|
|`--depth`|递归深度|0|
|`--file`, `-f`|添加一个条件 `type is file`|None|
|`--dir`, `-d`|添加一个条件 `type is dir`|None|
|`--link`, `-l`|添加一个条件 `type is link`|None|
|`--text`, `-t`|添加一个条件 `text has <TEXT>`，如果参数以`/`开头和结尾，则提取中间字符，操作符变为`match`。(可叠加)|*|
|`--mime`|添加一个条件 `mime is <MIME>` (可叠加)|*|
|`--do`|对查找出的文件进行内部操作(未实现)|*|
|`--exec`|对查找出的文件执行外部命令(未实现)|*|
|`--debug`|以调试模式运行|None|

## 运行细节

### 评估顺序
根据条件的输入顺序来执行，条件组会先收到`-q`选项的参数，然后接受来自位置参数的预处理结果，再接受来自其他选项的预处理结果。

### 递归策略
准备递归之前会在条件组中检索以下条件：
```
name not-*
path not-*
type not-*
```

1. 如果条件组中**有**上述条件，且目录符合其中一条，则不会继续递归。(排除机制)
2. 如果条件组中**没有**，上述条件，且前置评估已通过，不会继续递归。(非贪心匹配)

**提示**
比较`type` `is/not-is` `file/dir` 的差异可以得出有关的信息。
